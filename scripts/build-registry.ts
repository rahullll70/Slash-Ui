import { writeFileSync, readFileSync, existsSync, mkdirSync } from "fs";
import path from "path";
import { registry } from "../registry/index"; 

const OUTPUT_DIR = path.join(process.cwd(), "__registry__");
const OUTPUT_PATH = path.join(OUTPUT_DIR, "index.ts");

async function buildRegistry() {
  if (!existsSync(OUTPUT_DIR)) {
    mkdirSync(OUTPUT_DIR);
  }

  let indexContent = `// @ts-nocheck
// This file is autogenerated by scripts/build-registry.ts
import * as React from "react"

export const Index: Record<string, any> = {
  "default": {
`;

  registry.forEach((item) => {
    const filePath = path.join(process.cwd(), item.files[0]);
    const rawContent = existsSync(filePath) 
      ? readFileSync(filePath, "utf8")
      : "";

    const safeContent = rawContent
      .replace(/\\/g, "\\\\")
      .replace(/\`/g, "\\\`")
      .replace(/\$/g, "\\\$");

    const importPath = item.files[0].replace(/\.tsx?$/, "");

    // Inside your registry.forEach loop in build-registry.ts
indexContent += `    "${item.name}": {
      name: "${item.name}",
      type: "${item.type}",
      component: React.lazy(() => import("@/${importPath}")),
      files: ${JSON.stringify(item.files)},
      category: "${item.category || 'undefined'}",
      content: \`${safeContent}\`,
      // Add these lines for dynamic info
      description: "${item.description || 'A beautiful, handcrafted component.'}",
      install: "${item.install || 'npm install lucide-react clsx tailwind-merge'}",
    },
`;
  });
  indexContent += `  }
};`;
  writeFileSync(OUTPUT_PATH, indexContent);
  console.log("âœ… Slash UI Registry generated with Lazy Imports!");
}

buildRegistry();